# =============================================================================
# Ingress â€” AWS ALB Controller with TLS
# =============================================================================
# This manifest automatically provisions an Application Load Balancer (ALB)
# in AWS via the AWS Load Balancer Controller.
#
# Prerequisites:
#   1. AWS Load Balancer Controller installed in the cluster
#   2. ACM certificate created for your domain
#   3. DNS record pointing to the ALB (Route 53 or external DNS)
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: vprofile-ingress
  namespace: vprofile
  labels:
    app: vprofile
  annotations:
    # AWS Load Balancer Controller annotations
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"

    # Replace with your ACM certificate ARN
    alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:us-east-1:<ACCOUNT_ID>:certificate/<CERT_ID>"

    # Health check configuration
    alb.ingress.kubernetes.io/healthcheck-path: /api/actuator/health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "3"

    # Security headers
    alb.ingress.kubernetes.io/ssl-policy: ELBSecurityPolicy-TLS13-1-2-2021-06

    # Tags for AWS resources
    alb.ingress.kubernetes.io/tags: "Project=devsecops-pipeline,Environment=prod"
spec:
  ingressClassName: alb
  rules:
    - host: vprofile.yourdomain.com  # Replace with your actual domain
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: vprofile-svc
                port:
                  number: 80
